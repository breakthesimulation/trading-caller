<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Positions Dashboard - Trading Caller</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="modern-ui.css">
  <style>
    body {
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    .dashboard-header {
      margin-bottom: 2rem;
    }
    
    .dashboard-title {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, #10B981 0%, #3B82F6 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .dashboard-subtitle {
      font-size: 1.125rem;
      color: var(--text-secondary);
    }
    
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--border-color);
    }
    
    .tab {
      padding: 0.75rem 1.5rem;
      background: none;
      border: none;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: all var(--transition-base);
    }
    
    .tab:hover {
      color: var(--text-primary);
    }
    
    .tab.active {
      color: var(--accent-primary);
      border-bottom-color: var(--accent-primary);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-out;
    }
    
    .empty-state {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-secondary);
    }
    
    .empty-state-icon {
      font-size: 4rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .filter-bar {
      display: flex;
      gap: 1rem;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
    }
    
    .filter-button {
      padding: 0.5rem 1rem;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-base);
    }
    
    .filter-button:hover {
      background: var(--bg-hover);
    }
    
    .filter-button.active {
      background: var(--accent-primary);
      color: var(--text-inverse);
      border-color: var(--accent-primary);
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="dashboard-header">
      <h1 class="dashboard-title">‚ö° Positions Dashboard</h1>
      <p class="dashboard-subtitle">Real-time position tracking with P&L, status, and performance analytics</p>
    </header>
    
    <!-- Stats Overview -->
    <div class="stats-modern" id="stats-overview">
      <!-- Dynamically loaded stats -->
    </div>
    
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab active" data-tab="active">üü¢ Active Positions</button>
      <button class="tab" data-tab="waiting">üü° Waiting</button>
      <button class="tab" data-tab="closed">üìä Closed</button>
      <button class="tab" data-tab="all">üìã All</button>
    </div>
    
    <!-- Tab Content: Active Positions -->
    <div class="tab-content active" id="active-tab">
      <div class="modern-grid" id="active-positions">
        <!-- Dynamically loaded -->
      </div>
    </div>
    
    <!-- Tab Content: Waiting Positions -->
    <div class="tab-content" id="waiting-tab">
      <div class="modern-grid" id="waiting-positions">
        <!-- Dynamically loaded -->
      </div>
    </div>
    
    <!-- Tab Content: Closed Positions -->
    <div class="tab-content" id="closed-tab">
      <div class="filter-bar">
        <button class="filter-button active" data-filter="all">All</button>
        <button class="filter-button" data-filter="wins">‚úÖ Wins</button>
        <button class="filter-button" data-filter="losses">‚ùå Losses</button>
      </div>
      <div class="modern-grid" id="closed-positions">
        <!-- Dynamically loaded -->
      </div>
    </div>
    
    <!-- Tab Content: All Positions -->
    <div class="tab-content" id="all-tab">
      <div class="modern-grid" id="all-positions">
        <!-- Dynamically loaded -->
      </div>
    </div>
  </div>
  
  <script>
    const API_BASE = 'https://web-production-5e86c.up.railway.app';
    
    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        
        // Update active tab
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        
        // Update active content
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`${tabName}-tab`).classList.add('active');
      });
    });
    
    // Filter buttons
    document.querySelectorAll('.filter-button').forEach(btn => {
      btn.addEventListener('click', () => {
        const filter = btn.dataset.filter;
        
        document.querySelectorAll('.filter-button').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        
        loadClosedPositions(filter);
      });
    });
    
    // Format price
    function formatPrice(price) {
      if (!price) return 'N/A';
      if (price < 0.001) return `$${price.toExponential(2)}`;
      if (price < 1) return `$${price.toFixed(6)}`;
      return `$${price.toFixed(2)}`;
    }
    
    // Format P&L
    function formatPnL(pnl) {
      if (pnl === undefined || pnl === null) return 'N/A';
      const sign = pnl >= 0 ? '+' : '';
      return `${sign}${pnl.toFixed(2)}%`;
    }
    
    // Get P&L class
    function getPnLClass(pnl) {
      if (pnl > 0) return 'pnl-positive';
      if (pnl < 0) return 'pnl-negative';
      return 'pnl-neutral';
    }
    
    // Map status to display
    function mapStatus(status) {
      const statusMap = {
        'ACTIVE': 'active',
        'TP1_HIT': 'profitable',
        'TP2_HIT': 'profitable',
        'TP3_HIT': 'profitable',
        'STOPPED_OUT': 'stopped',
        'EXPIRED': 'loss',
        'PENDING': 'waiting',
      };
      return statusMap[status] || 'waiting';
    }
    
    // Create position card
    function createPositionCard(position) {
      const status = mapStatus(position.status);
      const pnl = position.pnl || 0;
      
      return `
        <div class="position-card fade-in">
          <div class="position-card-header">
            <div class="position-card-token">
              <span class="position-card-symbol">${position.token.symbol}</span>
              <span class="position-card-action position-card-action-${position.action.toLowerCase()}">
                ${position.action}
              </span>
            </div>
            <span class="position-status position-status-${status}">
              ${status === 'active' ? 'üü¢' : status === 'waiting' ? 'üü°' : status === 'profitable' ? '‚úÖ' : status === 'stopped' ? '‚è∏Ô∏è' : '‚ùå'}
              ${status.toUpperCase()}
            </span>
          </div>
          
          <div class="position-card-body">
            <div class="position-metric">
              <span class="position-metric-label">Entry</span>
              <span class="position-metric-value">${formatPrice(position.entry)}</span>
            </div>
            <div class="position-metric">
              <span class="position-metric-label">Current</span>
              <span class="position-metric-value">${formatPrice(position.current)}</span>
            </div>
            <div class="position-metric">
              <span class="position-metric-label">Stop Loss</span>
              <span class="position-metric-value">${formatPrice(position.stopLoss)}</span>
            </div>
            <div class="position-metric">
              <span class="position-metric-label">P&L</span>
              <span class="position-metric-value ${getPnLClass(pnl)}">
                ${formatPnL(pnl)}
              </span>
            </div>
          </div>
          
          <div class="signal-reasoning">
            <div class="signal-reasoning-item">
              <span class="signal-reasoning-label">Time:</span>
              <span class="signal-reasoning-text">${position.timeInPosition}</span>
            </div>
            <div class="signal-reasoning-item">
              <span class="signal-reasoning-label">Confidence:</span>
              <span class="signal-reasoning-text">${position.confidence}%</span>
            </div>
            ${position.reasoning ? `
              <div class="signal-reasoning-item">
                <span class="signal-reasoning-label">Technical:</span>
                <span class="signal-reasoning-text">${position.reasoning.technical}</span>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    // Load stats
    async function loadStats() {
      try {
        const response = await fetch(`${API_BASE}/positions/stats`);
        const data = await response.json();
        
        if (data.success) {
          const stats = data.stats;
          
          document.getElementById('stats-overview').innerHTML = `
            <div class="stat-modern stat-modern-highlight">
              <div class="stat-modern-value">${stats.openPositions}</div>
              <div class="stat-modern-label">Active Positions</div>
            </div>
            <div class="stat-modern">
              <div class="stat-modern-value">${stats.winRate.toFixed(1)}%</div>
              <div class="stat-modern-label">Win Rate</div>
            </div>
            <div class="stat-modern">
              <div class="stat-modern-value ${getPnLClass(stats.totalPnl)}">${formatPnL(stats.totalPnl)}</div>
              <div class="stat-modern-label">Total P&L</div>
            </div>
            <div class="stat-modern">
              <div class="stat-modern-value">${stats.wins}</div>
              <div class="stat-modern-label">Wins</div>
            </div>
            <div class="stat-modern">
              <div class="stat-modern-value">${stats.losses}</div>
              <div class="stat-modern-label">Losses</div>
            </div>
            <div class="stat-modern">
              <div class="stat-modern-value">${stats.profitFactor.toFixed(2)}</div>
              <div class="stat-modern-label">Profit Factor</div>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load stats:', error);
      }
    }
    
    // Load active positions
    async function loadActivePositions() {
      try {
        const response = await fetch(`${API_BASE}/positions/open`);
        const data = await response.json();
        
        const container = document.getElementById('active-positions');
        
        if (data.success && data.positions.length > 0) {
          container.innerHTML = data.positions.map(createPositionCard).join('');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üì≠</div>
              <h3>No Active Positions</h3>
              <p>When you have active trades, they'll appear here.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load active positions:', error);
      }
    }
    
    // Load waiting positions
    async function loadWaitingPositions() {
      try {
        const response = await fetch(`${API_BASE}/positions?status=PENDING`);
        const data = await response.json();
        
        const container = document.getElementById('waiting-positions');
        
        if (data.success && data.positions && data.positions.length > 0) {
          container.innerHTML = data.positions.map(createPositionCard).join('');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">‚è≥</div>
              <h3>No Waiting Positions</h3>
              <p>Positions waiting for entry will appear here.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load waiting positions:', error);
      }
    }
    
    // Load closed positions
    async function loadClosedPositions(filter = 'all') {
      try {
        const response = await fetch(`${API_BASE}/positions/closed?filter=${filter}&limit=50`);
        const data = await response.json();
        
        const container = document.getElementById('closed-positions');
        
        if (data.success && data.positions.length > 0) {
          container.innerHTML = data.positions.map(createPositionCard).join('');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìä</div>
              <h3>No Closed Positions</h3>
              <p>Completed trades will appear here.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load closed positions:', error);
      }
    }
    
    // Load all positions
    async function loadAllPositions() {
      try {
        const response = await fetch(`${API_BASE}/positions?limit=100`);
        const data = await response.json();
        
        const container = document.getElementById('all-positions');
        
        if (data.success && data.positions.length > 0) {
          container.innerHTML = data.positions.map(createPositionCard).join('');
        } else {
          container.innerHTML = `
            <div class="empty-state">
              <div class="empty-state-icon">üìã</div>
              <h3>No Positions Yet</h3>
              <p>Start trading to see your positions here.</p>
            </div>
          `;
        }
      } catch (error) {
        console.error('Failed to load all positions:', error);
      }
    }
    
    // Initial load
    loadStats();
    loadActivePositions();
    loadWaitingPositions();
    loadClosedPositions();
    loadAllPositions();
    
    // Auto-refresh every 30 seconds
    setInterval(() => {
      loadStats();
      loadActivePositions();
    }, 30000);
  </script>
</body>
</html>
